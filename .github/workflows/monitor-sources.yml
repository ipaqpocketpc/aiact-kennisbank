name: Monitor EU AI Act Sources

on:
  schedule:
    # Elke dag om 8:00 UTC (9:00 NL tijd)
    - cron: '0 8 * * *'
  workflow_dispatch: # Handmatig triggeren

# Required permissions for creating issues and pushing
permissions:
  contents: write
  issues: write

jobs:
  check-sources:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Check EU Digital Strategy RSS Feed
        id: check_updates
        run: |
          echo "Checking EU Digital Strategy RSS feed for AI Act updates..."
          
          # Get last check hash
          LAST_HASH=$(cat .github/last-check.txt 2>/dev/null || echo "none")
          echo "Last hash: $LAST_HASH"
          
          # Fetch RSS feed (much more reliable than HTML scraping)
          curl -s "https://digital-strategy.ec.europa.eu/en/rss.xml" > /tmp/rss.xml
          
          # Extract all titles from RSS
          grep -oP '(?<=<title>)[^<]+(?=</title>)' /tmp/rss.xml | tail -n +2 > /tmp/all_titles.txt
          
          # Filter for AI-related news (case insensitive)
          grep -iE 'AI|artificial intelligence|AI Act|GPAI|machine learning|algorithm' /tmp/all_titles.txt > /tmp/ai_titles.txt || true
          
          # Create hash of AI-related titles
          if [ -s /tmp/ai_titles.txt ]; then
            CURRENT_HASH=$(md5sum /tmp/ai_titles.txt | cut -d' ' -f1)
          else
            # If no AI titles, hash all titles
            CURRENT_HASH=$(md5sum /tmp/all_titles.txt | cut -d' ' -f1)
          fi
          
          echo "Current hash: $CURRENT_HASH"
          
          # Check if there are changes
          if [ "$LAST_HASH" != "$CURRENT_HASH" ]; then
            echo "Changes detected!"
            echo "has_updates=true" >> $GITHUB_OUTPUT
            
            # Get titles for the issue (prefer AI titles, fallback to recent)
            if [ -s /tmp/ai_titles.txt ]; then
              head -5 /tmp/ai_titles.txt > /tmp/issue_titles.txt
              echo "ai_specific=true" >> $GITHUB_OUTPUT
            else
              head -5 /tmp/all_titles.txt > /tmp/issue_titles.txt
              echo "ai_specific=false" >> $GITHUB_OUTPUT
            fi
            
            # Output titles for issue creation
            echo "titles<<EOF" >> $GITHUB_OUTPUT
            cat /tmp/issue_titles.txt >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            # Save new hash
            echo "$CURRENT_HASH" > .github/last-check.txt
          else
            echo "No changes detected"
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Create Issue if Updates Found
        if: steps.check_updates.outputs.has_updates == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const titles = `${{ steps.check_updates.outputs.titles }}`;
            const aiSpecific = '${{ steps.check_updates.outputs.ai_specific }}' === 'true';
            const today = new Date().toISOString().split('T')[0];
            
            const issueTitle = aiSpecific 
              ? `ðŸ¤– AI Act gerelateerd nieuws - ${today}`
              : `ðŸ“° EU Digital Strategy update - ${today}`;
            
            const titleList = titles
              .split('\n')
              .filter(t => t.trim())
              .map(t => `- ${t.trim()}`)
              .join('\n');
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: issueTitle,
              body: `## Nieuwe content gevonden!

            ${aiSpecific ? '**AI-gerelateerde updates gedetecteerd:**' : '**Recente updates:**'}

            ${titleList}

            ### Bronnen
            - [EU Digital Strategy RSS](https://digital-strategy.ec.europa.eu/en/rss.xml)
            - [AI Office](https://digital-strategy.ec.europa.eu/en/policies/ai-office)
            - [EUR-Lex AI Act](https://eur-lex.europa.eu/legal-content/NL/TXT/?uri=CELEX%3A32024R1689)

            ### Actie
            - [ ] Check de relevantie voor aiacteu.nl
            - [ ] Maak eventueel een update post
            - [ ] Update kennisbank indien nodig`,
              labels: ['nieuws', 'actie-nodig']
            });
            
      - name: Commit hash update
        if: steps.check_updates.outputs.has_updates == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .github/last-check.txt
          git diff --staged --quiet || git commit -m "chore: update source hash [skip ci]"
          git push || echo "Nothing to push"
