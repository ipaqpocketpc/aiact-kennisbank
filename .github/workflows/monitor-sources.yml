name: Monitor EU AI Act Sources

on:
  schedule:
    # Elke maandag om 9:00 UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Handmatig triggeren

jobs:
  check-sources:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Check AI Office Updates
        id: check_updates
        run: |
          # Fetch AI Office news page
          echo "Checking AI Office for updates..."
          
          # Get last check date from file or use 7 days ago
          LAST_CHECK=$(cat .github/last-check.txt 2>/dev/null || date -d '7 days ago' +%Y-%m-%d)
          echo "Last check: $LAST_CHECK"
          
          # Fetch latest news
          curl -s "https://digital-strategy.ec.europa.eu/en/news?topic=135" > /tmp/news.html
          
          # Extract titles (simplified - in production use proper HTML parser)
          grep -oP '(?<=<h3[^>]*>)[^<]+' /tmp/news.html | head -5 > /tmp/titles.txt
          
          # Check if there are new items
          if [ -s /tmp/titles.txt ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "titles<<EOF" >> $GITHUB_OUTPUT
            cat /tmp/titles.txt >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
          fi
          
          # Update last check date
          date +%Y-%m-%d > .github/last-check.txt
          
      - name: Create Issue if Updates Found
        if: steps.check_updates.outputs.has_updates == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const titles = `${{ steps.check_updates.outputs.titles }}`;
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Auto] Nieuwe EU AI Act publicaties gevonden`,
              body: `## Automatische check - ${new Date().toISOString().split('T')[0]}\n\nDe volgende nieuwe publicaties zijn gevonden:\n\n${titles.split('\n').map(t => `- ${t}`).join('\n')}\n\n### Bronnen\n- [AI Office News](https://digital-strategy.ec.europa.eu/en/news?topic=135)\n- [EUR-Lex AI Act](https://eur-lex.europa.eu/legal-content/NL/TXT/?uri=CELEX%3A32024R1689)\n\n### Actie\n- [ ] Controleer relevantie\n- [ ] Update kennisbank\n- [ ] Update website content`,
              labels: ['nieuws', 'auto-check']
            });
            
      - name: Commit last check date
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .github/last-check.txt || true
          git diff --staged --quiet || git commit -m "chore: update last check date"
          git push || true
