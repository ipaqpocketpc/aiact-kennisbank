name: Monitor EU AI Act Sources

on:
  schedule:
    # Elke dag om 8:00 UTC (9:00 NL tijd)
    - cron: '0 8 * * *'
  workflow_dispatch: # Handmatig triggeren

jobs:
  check-sources:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Check AI Office Updates
        id: check_updates
        run: |
          echo "Checking AI Office for updates..."
          
          # Get last check hash (use correct filename)
          LAST_HASH=$(cat .github/last-check.txt 2>/dev/null || echo "none")
          
          # Fetch latest news page
          curl -s "https://digital-strategy.ec.europa.eu/en/news?topic=135" > /tmp/news.html
          
          # Create hash of current content (more robust parsing)
          # Extract text content, filter for relevant items
          CURRENT_HASH=$(cat /tmp/news.html | grep -oE '<h[23][^>]*>[^<]+</h[23]>' | head -10 | md5sum | cut -d' ' -f1 || echo "empty")
          
          echo "Last hash: $LAST_HASH"
          echo "Current hash: $CURRENT_HASH"
          
          if [ "$LAST_HASH" != "$CURRENT_HASH" ] && [ "$CURRENT_HASH" != "empty" ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            
            # Extract titles (more robust)
            cat /tmp/news.html | grep -oE '<h3[^>]*>[^<]+</h3>' | sed 's/<[^>]*>//g' | head -5 > /tmp/titles.txt || true
            
            if [ -s /tmp/titles.txt ]; then
              echo "titles<<EOF" >> $GITHUB_OUTPUT
              cat /tmp/titles.txt >> $GITHUB_OUTPUT
              echo "EOF" >> $GITHUB_OUTPUT
            else
              echo "titles=Nieuwe content gedetecteerd (titels niet geparsed)" >> $GITHUB_OUTPUT
            fi
            
            # Save new hash
            echo "$CURRENT_HASH" > .github/last-check.txt
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "No changes detected"
          fi
          
      - name: Create Issue if Updates Found
        if: steps.check_updates.outputs.has_updates == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const titles = `${{ steps.check_updates.outputs.titles }}`;
            const today = new Date().toISOString().split('T')[0];
            
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Nieuwe AI Act publicatie - ${today}`,
              body: `## Nieuwe content gevonden!\n\nDe volgende nieuwe items zijn gedetecteerd:\n\n${titles.split('\n').filter(t => t.trim()).map(t => `- ${t}`).join('\n')}\n\n### Bronnen\n- [AI Office News](https://digital-strategy.ec.europa.eu/en/news?topic=135)\n- [EUR-Lex AI Act](https://eur-lex.europa.eu/legal-content/NL/TXT/?uri=CELEX%3A32024R1689)\n\n### Actie\n- [ ] Check de bron\n- [ ] Maak een update post op aiacteu.nl\n- [ ] Update kennisbank indien nodig`,
              labels: ['nieuws', 'actie-nodig']
            });
            
      - name: Commit hash update
        if: steps.check_updates.outputs.has_updates == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .github/last-check.txt
          git diff --staged --quiet || git commit -m "chore: update source hash"
          git push || echo "Nothing to push"
